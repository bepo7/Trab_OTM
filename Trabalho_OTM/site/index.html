<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otimizador de Portf√≥lio (Comparativo Triplo)</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-light: #e8f5e9;
            --header-color: #043d2e;
            --subtitle-color: #0b370e;
            --primary-color: #1f5d22;
            --secondary-color: #1a521c;
            --accent-color: #2e7d32;
            --text-dark: #1c3329;
            --gurobi-warm-color: #0056b3;
            /* Azul */
            --gurobi-cold-color: #6a1b9a;
            /* Roxo */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 64, 30, 0.15);
            width: 100%;
            max-width: 1000px;
            margin-top: 20px;
        }

        h1,
        h2 {
            color: var(--header-color);
            text-align: center;
        }

        .step {
            display: none;
            animation: fadeIn 0.5s;
        }

        .step.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Formul√°rio */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--subtitle-color);
        }

        /* GRID PARA INPUTS (Para caber os novos campos) */
        .form-grid-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn:hover {
            background-color: var(--primary-color);
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--secondary-color);
            color: var(--secondary-color);
            margin-top: 10px;
        }

        .sector-options {
            display: none;
            margin-top: 20px;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .sector-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        /* --- ABAS (TABS) --- */
        .tabs-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .tab-btn {
            padding: 12px 15px;
            border: none;
            background: none;
            font-size: 15px;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            border-bottom: 4px solid transparent;
            transition: 0.3s;
        }

        .tab-btn:hover {
            background-color: #f9f9f9;
        }

        .tab-btn.active {
            color: var(--secondary-color);
            border-bottom-color: var(--secondary-color);
        }

        .tab-btn.active-gu-warm {
            color: var(--gurobi-warm-color);
            border-bottom-color: var(--gurobi-warm-color);
        }

        .tab-btn.active-gu-cold {
            color: var(--gurobi-cold-color);
            border-bottom-color: var(--gurobi-cold-color);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        /* --- RESULTADOS --- */
        .metrics-summary {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: var(--primary-color);
            color: white;
            padding: 15px;
            border-radius: 8px;
        }

        .metrics-summary.gu-warm-theme {
            background: var(--gurobi-warm-color);
        }

        .metrics-summary.gu-cold-theme {
            background: var(--gurobi-cold-color);
        }

        .metric {
            text-align: center;
            flex: 1;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
        }

        .metric:last-child {
            border-right: none;
        }

        .metric-value {
            font-size: 18px;
            font-weight: bold;
        }

        .metric-label {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 4px;
        }

        .results-grid {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .result-base-card {
            background: #f8fdf9;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        /* CABE√áALHOS DAS TABELAS COM CONTADOR */
        .card-header-flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .card-header-flex h3 {
            margin: 0;
            color: var(--subtitle-color);
            font-size: 1.2em;
        }

        .count-badge {
            background-color: #e0e0e0;
            color: #333;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        /* Cores Badge */
        .count-badge.ga-theme { background-color: rgba(31, 93, 34, 0.1); color: var(--primary-color); }
        .count-badge.warm-theme { background-color: rgba(0, 86, 179, 0.1); color: var(--gurobi-warm-color); }
        .count-badge.cold-theme { background-color: rgba(106, 27, 154, 0.1); color: var(--gurobi-cold-color); }

        .plot-placeholder img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            max-width: 850px;
        }

        .chart-card {
            display: flex;
            justify-content: center;
        }

        .table-card {
            height: 450px; /* Mesma altura para ambas as tabelas */
            display: flex;
            flex-direction: column;
        }

        .table-scroll-area {
            flex-grow: 1;
            overflow-y: auto;
        }

        /* AJUSTE DAS TABELAS PARA FICAREM IGUAIS */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            table-layout: fixed; /* For√ßa larguras fixas */
        }

        /* DEFINI√á√ÉO DE LARGURA DE COLUNAS */
        .gurobi-table th:nth-child(1), .gurobi-table td:nth-child(1) { width: 30%; }
        .gurobi-table th:nth-child(2), .gurobi-table td:nth-child(2) { width: 30%; }
        .gurobi-table th:nth-child(3), .gurobi-table td:nth-child(3) { width: 20%; }
        .gurobi-table th:nth-child(4), .gurobi-table td:nth-child(4) { width: 20%; }

        /* LARGURAS ESPEC√çFICAS PARA GA (3 COLUNAS: Nome, Peso, Valor) */
        .ga-table th:nth-child(1), .ga-table td:nth-child(1) { width: 40%; }
        .ga-table th:nth-child(2), .ga-table td:nth-child(2) { width: 30%; }
        .ga-table th:nth-child(3), .ga-table td:nth-child(3) { width: 30%; }
        .ga-table th:nth-child(4), .ga-table td:nth-child(4) { display: none; }

        th { 
            position: sticky; top: 0; 
            background-color: #0b370e; 
            color: white; 
            padding: 12px; 
            font-size: 0.95rem; 
            z-index: 10; 
            /* Mant√©m o t√≠tulo alinhado √† esquerda */
            text-align: left; 
        }
        
        td { 
            /* Remove o 'text-align: left' padr√£o aqui para que a regra de alinhamento √† direita funcione */
            padding: 12px; 
            border-bottom: 1px solid #ddd; 
            font-size: 0.95rem; 
            color: #333; 
        }
        
        /* 2. For√ßa Alinhamento √† Direita nos Cabe√ßalhos */
        .gurobi-table th:nth-child(2), .gurobi-table th:nth-child(3), .gurobi-table th:nth-child(4), 
        .ga-table th:nth-child(2), .ga-table th:nth-child(3) {
            text-align: right !important;
        }

        /* 3. For√ßa Alinhamento √† Direita no Corpo da Tabela */
        .gurobi-table td:nth-child(2), .gurobi-table td:nth-child(3), .gurobi-table td:nth-child(4),
        .ga-table td:nth-child(2), .ga-table td:nth-child(3) {
            text-align: right !important;
        }

        tr:last-child td { border-bottom: none; }

        .gu-warm-table th {
            background-color: var(--gurobi-warm-color);
        }

        .gu-cold-table th {
            background-color: var(--gurobi-cold-color);
        }

        .line-chart-container {
            height: 450px;
            position: relative;
        }

        .loading-container {
            text-align: center;
            padding: 50px 0;
        }

        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--secondary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div class="container">

        <div id="step1" class="step active">
            <h1>Otimizador de Portf√≥lio</h1>
            <p style="text-align: center; color: #666;">Comparativo: GA vs. Gurobi</p>

            <div class="form-group">
                <label>Valor Total (R$)</label>
                <input type="number" id="valorTotal" value="10000">
            </div>
            
            <div class="form-grid-inputs">
                <div class="form-group">
                    <label>Avers√£o ao Risco (Lambda)</label>
                    <input type="number" id="lambdaFactor" value="20.0" step="0.1">
                </div>
                <div class="form-group">
                    <label>Volatilidade M√°xima (%)</label>
                    <input type="number" id="riskCap" value="15">
                </div>
            </div>

            <div class="form-grid-inputs">
                <div class="form-group">
                    <label>Teto M√°ximo por Ativo (%)</label>
                    <input type="number" id="maxAssetWeight" value="30" min="1" max="100">
                </div>
                <div class="form-group">
                    <label>Teto M√°ximo por Setor (%)</label>
                    <input type="number" id="maxSectorWeight" value="100" min="10" max="100">
                </div>
            </div>

            <div class="form-grid-inputs">
                <div class="form-group">
                    <label>M√°xima Quantidade de Ativos (Global)</label>
                    <input type="number" id="maxTotalAssets" value="30" min="1" step="1">
                </div>
                <div class="form-group">
                    <label>M√°xima Quantidade de Ativos (Por Setor)</label>
                    <input type="number" id="maxSectorAssets" value="8" min="1" step="1">
                </div>
            </div>

            <button class="btn" onclick="goToStep2()">Pr√≥ximo: Setores ‚Üí</button>
        </div>

        <div id="step2" class="step">
            <h2>Filtrar Setores</h2>
            <div class="form-group" style="background: #f1f8f6; padding: 15px; border-radius: 8px;">
                <label><input type="radio" name="sectorMode" value="all" checked onchange="toggleSectorList(false)">
                    Todos os setores</label>
                <label><input type="radio" name="sectorMode" value="custom" onchange="toggleSectorList(true)"> Escolher
                    manualmente</label>
            </div>
            <div id="sectorList" class="sector-options">
                {% for setor in setores %}
                <div class="sector-item"><label><input type="checkbox" value="{{ setor }}"> {{ setor }}</label></div>
                {% endfor %}
            </div>
            <button class="btn" onclick="startOptimization()">Calcular Otimiza√ß√£o üöÄ</button>
            <button class="btn btn-outline" onclick="goToStep1()">Voltar</button>
        </div>

        <div id="loading" class="step">
            <div class="loading-container">
                <div class="spinner"></div>
                <h2>Otimizando...</h2>
                <p>Executando Algoritmos (GA, Gurobi Warm, Gurobi Cold)...</p>
            </div>
        </div>

        <div id="results" class="step">
            <h2>Resultados</h2>

            <div class="tabs-container">
                <button class="tab-btn active" onclick="switchTab('ga')" id="btnTabGA">üß¨ AG (Aproximado)</button>
                <button class="tab-btn" onclick="switchTab('gu_warm')" id="btnTabGUWarm">üìê Gurobi (Com AG)</button>
                <button class="tab-btn" onclick="switchTab('gu_cold')" id="btnTabGUCold">ü§ñ Gurobi (Sem AG)</button>
            </div>

            <div id="content-ga" class="tab-content active">
                <div class="metrics-summary">
                    <div class="metric">
                        <div class="metric-value" id="val_GA">R$ 0</div>
                        <div class="metric-label">Investido</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="ret_GA">0%</div>
                        <div class="metric-label">Retorno</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="ris_GA">0%</div>
                        <div class="metric-label">Volatilidade</div>
                    </div>

                    <div class="metric">
                        <div class="metric-value" id="pvp_GA">0.00</div>
                        <div class="metric-label">P/VP</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="cvar_GA">0%</div>
                        <div class="metric-label">CVaR</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="obj_GA">0.0000</div>
                        <div class="metric-label">Fun√ß√£o Objetivo</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="time_GA">0.00s</div>
                        <div class="metric-label">Tempo (s)</div>
                    </div>
                </div>
                <div class="results-grid">
                    <div class="result-base-card chart-card">
                        <div class="plot-placeholder" id="plot_GA"></div>
                    </div>
                    
                    <div class="result-base-card table-card">
                        <div class="card-header-flex">
                            <h3>Aloca√ß√£o por Setor</h3>
                            <span class="count-badge ga-theme"><span id="qtd_setores_GA">0</span> Setores</span>
                        </div>
                        <div class="table-scroll-area">
                            <table id="table_sector_GA">
                                <thead>
                                    <tr>
                                        <th>Setor</th>
                                        <th>Peso (%)</th>
                                        <th>Valor (R$)</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="result-base-card table-card">
                        <div class="card-header-flex">
                            <h3>Detalhamento da Carteira</h3>
                            <span class="count-badge ga-theme"><span id="qtd_ativos_GA">0</span> Ativos</span>
                        </div>
                        <div class="table-scroll-area">
                            <table id="table_GA">
                                <thead>
                                    <tr>
                                        <th>Ativo</th>
                                        <th>Peso (%)</th>
                                        <th>Valor (R$)</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="result-base-card line-chart-container">
                        <canvas id="chart_line_GA"></canvas>
                    </div>
                </div>
            </div>

            <div id="content-gu_warm" class="tab-content">
                <div class="metrics-summary gu-warm-theme">
                    <div class="metric">
                        <div class="metric-value" id="val_GU_WARM">R$ 0</div>
                        <div class="metric-label">Investido</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="ret_GU_WARM">0%</div>
                        <div class="metric-label">Retorno</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="ris_GU_WARM">0%</div>
                        <div class="metric-label">Volatilidade</div>
                    </div>

                    <div class="metric">
                        <div class="metric-value" id="pvp_GU_WARM">0.00</div>
                        <div class="metric-label">P/VP</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="cvar_GU_WARM">0%</div>
                        <div class="metric-label">CVaR</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="obj_GU_WARM">0.0000</div>
                        <div class="metric-label">Fun√ß√£o Objetivo</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="time_GU_WARM">0.00s</div>
                        <div class="metric-label">Tempo (s)</div>
                    </div>
                </div>
                <div class="results-grid">
                    <div class="result-base-card chart-card">
                        <div class="plot-placeholder" id="plot_GU_WARM"></div>
                    </div>
                    
                    <div class="result-base-card table-card">
                        <div class="card-header-flex">
                            <h3>Aloca√ß√£o por Setor</h3>
                            <span class="count-badge warm-theme"><span id="qtd_setores_GU_WARM">0</span> Setores</span>
                        </div>
                        <div class="table-scroll-area">
                            <table id="table_sector_GU_WARM" class="gu-warm-table">
                                <thead>
                                    <tr>
                                        <th>Setor</th>
                                        <th>Cotas</th>
                                        <th>Peso (%)</th>
                                        <th>Valor (R$)</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="result-base-card table-card">
                        <div class="card-header-flex">
                            <h3>Detalhamento da Carteira</h3>
                            <span class="count-badge warm-theme"><span id="qtd_ativos_GU_WARM">0</span> Ativos</span>
                        </div>
                        <div class="table-scroll-area">
                            <table id="table_GU_WARM" class="gu-warm-table">
                                <thead>
                                    <tr>
                                        <th>Ativo</th>
                                        <th>Cotas</th>
                                        <th>Peso (%)</th>
                                        <th>Valor (R$)</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="result-base-card line-chart-container">
                        <canvas id="chart_line_GU_WARM"></canvas>
                    </div>
                </div>
            </div>

            <div id="content-gu_cold" class="tab-content">
                <div class="metrics-summary gu-cold-theme">
                    <div class="metric">
                        <div class="metric-value" id="val_GU_COLD">R$ 0</div>
                        <div class="metric-label">Investido</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="ret_GU_COLD">0%</div>
                        <div class="metric-label">Retorno</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="ris_GU_COLD">0%</div>
                        <div class="metric-label">Volatilidade</div>
                    </div>

                    <div class="metric">
                        <div class="metric-value" id="pvp_GU_COLD">0.00</div>
                        <div class="metric-label">P/VP</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="cvar_GU_COLD">0%</div>
                        <div class="metric-label">CVaR</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="obj_GU_COLD">0.0000</div>
                        <div class="metric-label">Fun√ß√£o Objetivo</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="time_GU_COLD">0.00s</div>
                        <div class="metric-label">Tempo (s)</div>
                    </div>
                </div>
                <div class="results-grid">
                    <div class="result-base-card chart-card">
                        <div class="plot-placeholder" id="plot_GU_COLD"></div>
                    </div>
                    
                    <div class="result-base-card table-card">
                        <div class="card-header-flex">
                            <h3>Aloca√ß√£o por Setor</h3>
                            <span class="count-badge cold-theme"><span id="qtd_setores_GU_COLD">0</span> Setores</span>
                        </div>
                        <div class="table-scroll-area">
                            <table id="table_sector_GU_COLD" class="gu-cold-table">
                                <thead>
                                    <tr>
                                        <th>Setor</th>
                                        <th>Cotas</th>
                                        <th>Peso (%)</th>
                                        <th>Valor (R$)</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="result-base-card table-card">
                        <div class="card-header-flex">
                            <h3>Detalhamento da Carteira</h3>
                            <span class="count-badge cold-theme"><span id="qtd_ativos_GU_COLD">0</span> Ativos</span>
                        </div>
                        <div class="table-scroll-area">
                            <table id="table_GU_COLD" class="gu-cold-table">
                                <thead>
                                    <tr>
                                        <th>Ativo</th>
                                        <th>Cotas</th>
                                        <th>Peso (%)</th>
                                        <th>Valor (R$)</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="result-base-card line-chart-container">
                        <canvas id="chart_line_GU_COLD"></canvas>
                    </div>
                </div>
            </div>

            <button class="btn btn-outline" onclick="location.reload()" style="margin-top: 30px;">Nova
                Simula√ß√£o</button>
        </div>

    </div>

    <div id="statusBar"
        style="position: fixed; bottom: 20px; right: 20px; background: white; padding: 10px 20px; border-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: bold; color: #333; transition: opacity 0.5s;">
        <div class="mini-spinner"
            style="border: 3px solid #f3f3f3; border-top: 3px solid #2e7d32; border-radius: 50%; width: 15px; height: 15px; animation: spin 1s linear infinite;">
        </div>
        <span id="statusText">Iniciando sistema...</span>
    </div>

    <script>
        // --- VARI√ÅVEIS GLOBAIS ---
        let paretoChartInstance = null;
        const chartInstances = { GA: null, GU_WARM: null, GU_COLD: null };

        // --- L√ìGICA DE PR√â-CARREGAMENTO ---
        document.addEventListener("DOMContentLoaded", function () {
            fetch('/pre-carregar')
                .then(res => res.json())
                .then(data => {
                    console.log("Pr√©-carregamento iniciado:", data);
                    verificarStatus();
                })
                .catch(err => console.error("Erro ao iniciar pr√©-load", err));
        });

        function verificarStatus() {
            const statusBar = document.getElementById('statusBar');
            const statusText = document.getElementById('statusText');

            const intervalo = setInterval(async () => {
                try {
                    const response = await fetch('/status-dados');
                    const data = await response.json();

                    statusText.innerText = data.status;

                    if (data.status === "Dados Prontos") {
                        statusText.innerText = "Sistema Pronto!";
                        setTimeout(() => {
                            statusBar.style.opacity = '0';
                            setTimeout(() => {
                                statusBar.style.display = 'none';
                                clearInterval(intervalo);
                            }, 500);
                        }, 1000);
                    }
                    else if (data.status === "Erro" || data.status === "Erro no Download") {
                        statusBar.style.color = "red";
                        clearInterval(intervalo);
                    }

                } catch (error) {
                    console.error("Erro ao verificar status:", error);
                }
            }, 1000);
        }

        // --- FUN√á√ïES DE UI ---
        function showStep(id) {
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        function goToStep1() { showStep('step1'); }
        function goToStep2() { showStep('step2'); }
        function toggleSectorList(show) { document.getElementById('sectorList').style.display = show ? 'block' : 'none'; }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('active'); el.classList.remove('active-gu-warm'); el.classList.remove('active-gu-cold');
            });
            document.getElementById('content-' + tabName).classList.add('active');

            const btn = document.getElementById('btnTab' + tabName.toUpperCase().replace('_', ''));
            if (tabName === 'gu_warm') btn.classList.add('active-gu-warm');
            else if (tabName === 'gu_cold') btn.classList.add('active-gu-cold');
            else btn.classList.add('active');
        }

        // --- EXECU√á√ÉO PRINCIPAL ---
        async function startOptimization() {
            const modoSetor = document.querySelector('input[name="sectorMode"]:checked').value;
            let proibidos = [];
            if (modoSetor === 'custom') {
                document.querySelectorAll('#sectorList input[type="checkbox"]').forEach(cb => { if (!cb.checked) proibidos.push(cb.value); });
            }
            
            // PEGAR OS VALORES DOS NOVOS INPUTS
            const maxGlobal = document.getElementById('maxTotalAssets').value;
            const maxSector = document.getElementById('maxSectorAssets').value;

            showStep('loading');

            try {
                const response = await fetch('/otimizar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        valor: document.getElementById('valorTotal').value,
                        lambda: document.getElementById('lambdaFactor').value,
                        risco: document.getElementById('riskCap').value,
                        teto_ativo: document.getElementById('maxAssetWeight').value,
                        teto_setor: document.getElementById('maxSectorWeight').value,
                        proibidos: proibidos,
                        // ENVIA OS NOVOS PARAMETROS PARA O PYTHON
                        max_ativos: maxGlobal,
                        max_ativos_setor: maxSector
                    })
                });
                const data = await response.json();
                if (!data.sucesso) throw new Error(data.erro);

                renderizarTudo(data);
                showStep('results');

            } catch (error) {
                alert("Erro: " + error.message);
                showStep('step2');
            }
        }

        function renderizarTudo(data) {
            fillData('GA', data.ga);
            if (data.gurobi_warm) {
                document.getElementById('btnTabGUWarm').style.display = 'inline-block';
                fillData('GU_WARM', data.gurobi_warm);
            } else document.getElementById('btnTabGUWarm').style.display = 'none';

            if (data.gurobi_cold) {
                document.getElementById('btnTabGUCold').style.display = 'inline-block';
                fillData('GU_COLD', data.gurobi_cold);
            } else document.getElementById('btnTabGUCold').style.display = 'none';

            switchTab('ga');
        }

        function fillData(suffix, obj) {
            // M√©tricas
            document.getElementById(`val_${suffix}`).innerText = Number(obj.metricas.valor_investido).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById(`ret_${suffix}`).innerText = obj.metricas.retorno_aa.toFixed(2) + '%';
            document.getElementById(`ris_${suffix}`).innerText = obj.metricas.risco_aa.toFixed(2) + '%';
            if (obj.metricas.pvp !== undefined) document.getElementById(`pvp_${suffix}`).innerText = obj.metricas.pvp.toFixed(2);
            if (obj.metricas.cvar !== undefined) document.getElementById(`cvar_${suffix}`).innerText = obj.metricas.cvar.toFixed(2) + '%';
            if (obj.metricas.score) document.getElementById(`obj_${suffix}`).innerText = obj.metricas.score.toFixed(5);
            if (obj.metricas.tempo !== undefined) document.getElementById(`time_${suffix}`).innerText = obj.metricas.tempo.toFixed(4) + 's';

            // --- ATUALIZAR CONTADORES NO HEADER ---
            if(document.getElementById(`qtd_ativos_${suffix}`)) {
                document.getElementById(`qtd_ativos_${suffix}`).innerText = obj.metricas.qtd_ativos || 0;
            }
            if(document.getElementById(`qtd_setores_${suffix}`)) {
                document.getElementById(`qtd_setores_${suffix}`).innerText = obj.metricas.qtd_setores || 0;
            }

            // Pizza
            document.getElementById(`plot_${suffix}`).innerHTML = `<img src="${obj.grafico_url}" alt="Gr√°fico ${suffix}">`;

            // --- TABELA DE SETORES (SEM NEGRITO NOS N√öMEROS) ---
            // PREENCHIMENTO TABELA SETORES
            const tbodySector = document.querySelector(`#table_sector_${suffix} tbody`);
            if (tbodySector && obj.alocacao_setorial) {
                tbodySector.innerHTML = '';
                obj.alocacao_setorial.forEach(item => {
                    // Come√ßa a linha
                    let linha = `<tr><td style="font-weight:600; color:#555;">${item.setor}</td>`;
                    
                    // --- MUDAN√áA AQUI: S√≥ adiciona QTD se N√ÉO for GA ---
                    if (suffix !== 'GA') {
                        linha += `<td>${item.qtd}</td>`;
                    }
                    // --------------------------------------------------
                    
                    linha += `<td>${item.peso.toFixed(2)}%</td>
                              <td>${item.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td></tr>`;
                    tbodySector.innerHTML += linha;
                });
            }

            // PREENCHIMENTO TABELA ATIVOS (Mesma l√≥gica)
            const tbody = document.querySelector(`#table_${suffix} tbody`);
            tbody.innerHTML = '';
            obj.alocacao.forEach(item => {
                let linha = `<tr><td style="font-weight:600; color:#555;">${item.ativo}</td>`;
                
                // --- MUDAN√áA AQUI ---
                if (suffix !== 'GA') {
                    linha += `<td>${item.qtd}</td>`;
                }
                // --------------------
                
                linha += `<td>${item.peso.toFixed(2)}%</td>
                          <td>${item.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td></tr>`;
                tbody.innerHTML += linha;
            });

            // Gr√°fico Hist√≥rico
            if (obj.backtest) {
                renderizarGraficoBacktest(suffix, obj.backtest);
            }
        }

        function renderizarGraficoBacktest(suffix, dataBacktest) {
            const canvasId = `chart_line_${suffix}`;
            const ctx = document.getElementById(canvasId).getContext('2d');
            const valorInvestido = parseFloat(document.getElementById('valorTotal').value) || 10000;

            if (chartInstances[suffix]) chartInstances[suffix].destroy();

            let colorLine = '#1f5d22'; let colorFill = 'rgba(31, 93, 34, 0.1)';
            if (suffix === 'GU_WARM') { colorLine = '#0056b3'; colorFill = 'rgba(0, 86, 179, 0.1)'; }
            else if (suffix === 'GU_COLD') { colorLine = '#6a1b9a'; colorFill = 'rgba(106, 27, 154, 0.1)'; }

            const fator = valorInvestido / 100.0;
            const safeMap = (arr) => arr ? arr.map(v => v * fator) : [];

            chartInstances[suffix] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dataBacktest.datas,
                    datasets: [
                        { label: 'Minha Carteira', data: safeMap(dataBacktest.carteira), borderColor: colorLine, backgroundColor: colorFill, borderWidth: 2, pointRadius: 0, fill: true, tension: 0.1 },
                        { label: 'CDI', data: safeMap(dataBacktest.cdi), borderColor: '#333', borderWidth: 2, borderDash: [5, 5], pointRadius: 0, fill: false, tension: 0.1 },
                        { label: 'Ibovespa', data: safeMap(dataBacktest.ibov), borderColor: '#888', borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.1 },
                        { label: 'S&P 500 (BRL)', data: safeMap(dataBacktest.sp500), borderColor: '#d32f2f', borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.1 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    plugins: {
                        title: { display: true, text: 'Simula√ß√£o de Patrim√¥nio (Hist√≥rico)', font: { size: 16 } },
                        tooltip: { callbacks: { label: function (c) { return (c.dataset.label || '') + ': ' + new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(c.parsed.y); } } },
                        legend: { position: 'top', labels: { usePointStyle: true, boxWidth: 8 } }
                    },
                    scales: {
                        x: { display: true, ticks: { maxTicksLimit: 8 } },
                        y: { display: true, title: { display: true, text: 'Patrim√¥nio (R$)' }, ticks: { callback: function (v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', maximumSignificantDigits: 3 }).format(v); } } }
                    }
                }
            });
        }
    </script>

</body>

</html>