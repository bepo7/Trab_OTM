<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otimizador de Portf√≥lio (Comparativo)</title>
    <style>
        :root {
            --bg-light: #e8f5e9;
            --header-color: #043d2e;
            --subtitle-color: #0b370e;
            --primary-color: #1f5d22;
            --secondary-color: #1a521c;
            --accent-color: #2e7d32;
            --text-dark: #1c3329;
            --gurobi-color: #0056b3; /* Azul para diferenciar Gurobi */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            margin: 0; padding: 20px;
            display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            background-color: white; padding: 30px; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 64, 30, 0.15);
            width: 100%; max-width: 1000px;
            margin-top: 20px;
        }

        h1, h2 { color: var(--header-color); text-align: center; }
        .step { display: none; animation: fadeIn 0.5s; }
        .step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Estilos de Formul√°rio */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--subtitle-color); }
        input[type="number"], select {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;
            box-sizing: border-box;
        }
        .btn {
            width: 100%; padding: 15px; background-color: var(--secondary-color); color: white;
            border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer;
            transition: 0.3s;
        }
        .btn:hover { background-color: var(--primary-color); }
        .btn-outline { background-color: transparent; border: 2px solid var(--secondary-color); color: var(--secondary-color); margin-top: 10px; }

        .sector-options { display: none; margin-top: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto; }
        .sector-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f0f0f0; }
        
        /* --- ESTILOS DAS ABAS (TABS) --- */
        .tabs-container {
            display: flex; justify-content: center; margin-bottom: 20px; border-bottom: 2px solid #eee;
        }
        .tab-btn {
            padding: 12px 25px; border: none; background: none; font-size: 16px; font-weight: bold;
            color: #666; cursor: pointer; border-bottom: 4px solid transparent; transition: 0.3s;
        }
        .tab-btn:hover { background-color: #f9f9f9; }
        .tab-btn.active { color: var(--secondary-color); border-bottom-color: var(--secondary-color); }
        .tab-btn.active-gurobi { color: var(--gurobi-color); border-bottom-color: var(--gurobi-color); }
        
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }

        /* --- RESULTADOS --- */
        .metrics-summary {
            display: flex; justify-content: space-between; /* Espalha os 4 itens */
            margin-bottom: 20px;
            background: var(--primary-color); color: white; padding: 15px; border-radius: 8px;
        }
        .metrics-summary.gurobi-theme { background: var(--gurobi-color); }
        
        .metric { text-align: center; flex: 1; border-right: 1px solid rgba(255,255,255,0.2); }
        .metric:last-child { border-right: none; }
        
        .metric-value { font-size: 22px; font-weight: bold; }
        .metric-label { font-size: 13px; opacity: 0.9; margin-top: 4px; }

        .results-grid { display: flex; flex-direction: column; gap: 30px; }
        .result-base-card { background: #f8fdf9; padding: 20px; border-radius: 10px; border: 1px solid #e0e0e0; }
        .plot-placeholder img { width: 100%; height: auto; border-radius: 8px; }

        /* Tabela */
        .table-card { height: 500px; display: flex; flex-direction: column; }
        .table-scroll-area { flex-grow: 1; overflow-y: auto; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #ddd; }
        th { position: sticky; top: 0; background-color: var(--subtitle-color); color: white; }
        .gurobi-table th { background-color: var(--gurobi-color); }

        /* Loading */
        .loading-container { text-align: center; padding: 50px 0; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid var(--secondary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">

    <div id="step1" class="step active">
        <h1>Otimizador de Portf√≥lio</h1>
        <p style="text-align: center; color: #666;">Comparativo: Algoritmo Gen√©tico vs. Solver Exato</p>
        
        <div class="form-group">
            <label>Valor Total (R$)</label>
            <input type="number" id="valorTotal" value="10000">
        </div>
        <div class="form-group">
            <label>Avers√£o ao Risco (Lambda)</label>
            <input type="number" id="lambdaFactor" value="50.0" step="0.1">
        </div>
        <div class="form-group">
            <label>Risco M√°ximo (%)</label>
            <input type="number" id="riskCap" value="15">
        </div>

        <button class="btn" onclick="goToStep2()">Pr√≥ximo: Setores ‚Üí</button>
    </div>

    <div id="step2" class="step">
        <h2>Filtrar Setores</h2>
        <div class="form-group" style="background: #f1f8f6; padding: 15px; border-radius: 8px;">
            <label><input type="radio" name="sectorMode" value="all" checked onchange="toggleSectorList(false)"> Todos os setores</label>
            <label><input type="radio" name="sectorMode" value="custom" onchange="toggleSectorList(true)"> Escolher manualmente</label>
        </div>
        <div id="sectorList" class="sector-options">
            {% for setor in setores %}
            <div class="sector-item"><label><input type="checkbox" value="{{ setor }}"> {{ setor }}</label></div>
            {% endfor %}
        </div>
        <button class="btn" onclick="startOptimization()">Calcular Otimiza√ß√£o üöÄ</button>
        <button class="btn btn-outline" onclick="goToStep1()">Voltar</button>
    </div>

    <div id="loading" class="step">
        <div class="loading-container">
            <div class="spinner"></div>
            <h2>Otimizando...</h2>
            <p>Calculando fronteira eficiente com GA e refinando com Gurobi.</p>
        </div>
    </div>

    <div id="results" class="step">
        <h2>Resultados da Otimiza√ß√£o</h2>
        
        <div class="tabs-container">
            <button class="tab-btn active" onclick="switchTab('ga')" id="btnTabGA">üß¨ Algoritmo Gen√©tico</button>
            <button class="tab-btn" onclick="switchTab('gurobi')" id="btnTabGU">üìê Gurobi (Exato)</button>
        </div>

        <div id="content-ga" class="tab-content active">
            <div class="metrics-summary">
                <div class="metric"><div class="metric-value" id="val_GA">R$ 0</div><div class="metric-label">Investido</div></div>
                <div class="metric"><div class="metric-value" id="ret_GA">0%</div><div class="metric-label">Retorno</div></div>
                <div class="metric"><div class="metric-value" id="ris_GA">0%</div><div class="metric-label">Risco</div></div>
                <div class="metric"><div class="metric-value" id="obj_GA">0.0000</div><div class="metric-label">Fun√ß√£o Objetivo</div></div>
            </div>
            <div class="results-grid">
                <div class="result-base-card chart-card">
                    <div class="plot-placeholder" id="plot_GA"></div>
                </div>
                <div class="result-base-card table-card">
                    <div class="table-scroll-area">
                        <table id="table_GA">
                            <thead><tr><th>Ativo</th><th>Peso</th><th>Valor</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-gurobi" class="tab-content">
            <div class="metrics-summary gurobi-theme">
                <div class="metric"><div class="metric-value" id="val_GU">R$ 0</div><div class="metric-label">Investido</div></div>
                <div class="metric"><div class="metric-value" id="ret_GU">0%</div><div class="metric-label">Retorno (√ìtimo)</div></div>
                <div class="metric"><div class="metric-value" id="ris_GU">0%</div><div class="metric-label">Risco</div></div>
                <div class="metric"><div class="metric-value" id="obj_GU">0.0000</div><div class="metric-label">Fun√ß√£o Objetivo</div></div>
            </div>
            <div class="results-grid">
                <div class="result-base-card chart-card">
                    <div class="plot-placeholder" id="plot_GU"></div>
                </div>
                <div class="result-base-card table-card">
                    <div class="table-scroll-area">
                        <table id="table_GU" class="gurobi-table">
                            <thead><tr><th>Ativo</th><th>Peso</th><th>Valor</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <button class="btn btn-outline" onclick="location.reload()" style="margin-top: 30px;">Nova Simula√ß√£o</button>
    </div>

</div>

<script>
    function showStep(id) {
        document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
    function goToStep1() { showStep('step1'); }
    function goToStep2() { showStep('step2'); }
    function toggleSectorList(show) { document.getElementById('sectorList').style.display = show ? 'block' : 'none'; }

    // --- L√ìGICA DAS ABAS ---
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => {
            el.classList.remove('active');
            el.classList.remove('active-gurobi');
        });

        document.getElementById('content-' + tabName).classList.add('active');
        
        const btn = document.getElementById(tabName === 'ga' ? 'btnTabGA' : 'btnTabGU');
        if (tabName === 'gurobi') {
            btn.classList.add('active-gurobi');
        } else {
            btn.classList.add('active');
        }
    }

    async function startOptimization() {
        const modoSetor = document.querySelector('input[name="sectorMode"]:checked').value;
        let proibidos = [];
        
        if (modoSetor === 'custom') {
            document.querySelectorAll('#sectorList input[type="checkbox"]').forEach(cb => {
                if (!cb.checked) proibidos.push(cb.value);
            });
        }

        showStep('loading');

        try {
            const response = await fetch('/otimizar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    valor: document.getElementById('valorTotal').value,
                    lambda: document.getElementById('lambdaFactor').value,
                    risco: document.getElementById('riskCap').value,
                    proibidos: proibidos
                })
            });
            const data = await response.json();
            
            if (!data.sucesso) throw new Error(data.erro);

            renderizarTudo(data);
            showStep('results');

        } catch (error) {
            alert("Erro: " + error.message);
            showStep('step2');
        }
    }

    function renderizarTudo(data) {
        // 1. Renderizar GA
        fillData('GA', data.ga);

        // 2. Renderizar Gurobi (se existir)
        if (data.gurobi) {
            document.getElementById('btnTabGU').style.display = 'inline-block';
            fillData('GU', data.gurobi);
        } else {
            document.getElementById('btnTabGU').style.display = 'none';
        }
        
        // Volta para a aba GA por padr√£o
        switchTab('ga');
    }

    function fillData(suffix, obj) {
        // Preenche M√©tricas
        document.getElementById(`val_${suffix}`).innerText = 
            Number(obj.metricas.valor_investido).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        
        document.getElementById(`ret_${suffix}`).innerText = obj.metricas.retorno_aa.toFixed(2) + '%';
        document.getElementById(`ris_${suffix}`).innerText = obj.metricas.risco_aa.toFixed(2) + '%';

        // --- NOVO: Preenche Fun√ß√£o Objetivo ---
        if (obj.metricas.score) {
            document.getElementById(`obj_${suffix}`).innerText = obj.metricas.score.toFixed(5);
        }

        // Preenche Imagem
        document.getElementById(`plot_${suffix}`).innerHTML = `<img src="${obj.grafico_url}" alt="Gr√°fico ${suffix}">`;

        // Preenche Tabela
        const tbody = document.querySelector(`#table_${suffix} tbody`);
        tbody.innerHTML = '';
        obj.alocacao.forEach(item => {
            tbody.innerHTML += `
                <tr>
                    <td style="font-weight:bold">${item.ativo}</td>
                    <td>${item.peso.toFixed(2)}%</td>
                    <td>${item.valor.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</td>
                </tr>`;
        });
    }
</script>

</body>
</html>